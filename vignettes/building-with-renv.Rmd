---
title: "Building Lessons With A Package Cache"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Building Lessons With A Package Cache}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#|"
)
```

## Quickstart

If you are working on a lesson that has content with generated output, then this
guide is for you. This will get you started using a local package cache separate
from your default library for your lessons that ensure you can reproduce your
lesson locally.

To get started, you need to *explicitly* give {sandpaper} permission to create
and use a cache with the function `use_package_cache()`

```{r setup}
library("sandpaper")
```

```{r use_package_cache, eval = FALSE}
use_package_cache()
```
```{r output, echo = FALSE}
msg <- readLines(system.file("resources/WELCOME", package = "renv"))
msg <- gsub("${RENV_PATHS_ROOT}", dQuote("/path/to/cache"), msg, fixed = TRUE)
choices <- sandpaper:::package_cache_msg(msg)
cat(paste(c("1:", "2:"), choices), sep = "\n")
```

## Introduction


One of the biggest motivations for building the lesson infrastructure around
{sandpaper} is to be mindful of how we build lessons with generated content. For
the moment, these are explicitly R Markdown lessons, but in the future, it is
possible for us to expand to different engines *without changing your lesson's*
setup.

In the past, we've done this by including a script inside the lesson template
that would automatically scan the dependencies of your lesson and install them
to your computer. While convenient, there were drawbacks to this method in that
it would alter your personal R library if any of the packages update, which was
not good if you were using R for you own work and wanted to preserve the package
versions that you had.

The {sandpaper} engine is mindful of lessons with generated content in the
following ways:

- *reliable setup*: the version of the lesson built on the carpentries website
  will be the same as what you build on your computer because the packages will
  be identical

- *environmentally friendly*: The lesson dependencies are NOT stored in your
  default R library and they will not alter your R environment.

- *transparent*: any additions or deletions to the cache will be recorded in
  the lockfile, which is tracked by git.

The ‘renv’ package provides a very useful interface to bring one aspect of
reproducibility to R projects. Because people working on Carpentries lessons
are also working academics and will likely have projects on their computer
where the package versions are necessary for their work, it's important that
those environments are respected.

Our flavor of renv applies a package cache explicitly to the content of the
lesson, but does not impose itself as the default renv environment.

This provisioner will do the following steps:

 1. check for consent to use the package cache via ‘use_package_cache()’ and
    prompt for it if needed

 2. check if the profile has been created and create it if needed via
    ‘renv::init()’

 3. populate the cache with packages needed from the user's system and download
    any that are missing via ‘renv::hydrate()’. This includes all new packages
    that have been added to the lesson.

 4. If there is a lockfile already present, make sure the packages in the cache
    are aligned with the lockfile (downloading sources if needed) via
    ‘renv::restore()’.

 5. Record the state of the cache in a lockfile tracked by git.  This will
    include adding new packages and removing old packages. ‘renv::snapshot()’

When the lockfile changes, you will see it in git and have the power to either
commit or restore those changes.

