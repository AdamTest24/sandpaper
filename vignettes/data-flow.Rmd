---
title: "Data and Flow from Source to Website"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Data and Flow from Source to Website}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "##"
)
```

## Introduction

This is a vignette that is designed for R package developers who are looking to
understand how the data flows between the lesson source and the final website.
I am assuming that the person reading this has familiarity with 
[R packaging](https://r-pkgs.org/) and [R
environments](https://r-pkgs.org/data.html#sec-data-state).

One of the design philosophies of The Workbench is that if a lesson author or
contributor would like to add any sort of metadata or modify a setting in any
given lesson, they can do so by editing the source of the lesson with no need to
modify their workflow.

### Two Sources of Metadata

Metadata is different from content because, while it is not directly related to
the content, it has extra information that helps the users of the site navigate
the content. For example, each episode page has three piece of metadata
embedded as a YAML list at the top of the source file that defines the title
along with estimated time for teaching and excercises.

```yaml
title: "Introduction"
teaching: 5
exercises: 5
```

In terms of the lesson itself, metadata that is related to the whole lesson is
stored in `config.yaml`. This YAML file is designed to be as flat as possible to
avoid common problems with writing YAML. Metadata here include things like the
title of the Lesson, the source page of the lesson, the time it was created, and
the lesson program it belongs to.

```yaml
title: "An Example Lesson"
carpentry: "incubator"
created: "2023-11-27"
life-cycle: "pre-alpha"
```

It also defines optional parameters such as the order of the episodes and other content that can be used to customise how the lesson is built.

```yaml
episodes:
 - introduction.md
 - first-example.md

handout: true
```

The thing to know about this metdata and these variables is that they all get
passed to {varnish} and are used to control how the lesson website is built
along with the metadata.

### An introduction to `{varnish}`

In order to understand how to pass data from `config.yaml` to {varnish}, it is
important to first understand the paradigm of how {sandpaper} and {varnish} work
together to produce a lesson website. Behind the scenes, we build markdown with
{knitr}, render the raw HTML with Pandoc and then use {pkgdown} to insert the
HTML and metadata into a template (written in [the logicless templating
language, Mustache](https://mustache.github.io/mustache.5.html)) that can be
updated and modified independently of {sandpaper}. This template is called
{varnish}.

In the paradigm of {pkgdown}, the HTML template is split up into different
components that are rendered separately and then combined into a single layout
template. For example, here is the template that defines the layout:


````{r varnish-template-layout, echo = FALSE, results = "asis"}
writeLines("```html")
tplt <- system.file("pkgdown", "templates", "layout.html", package = "varnish")
writeLines(readLines(tplt))
writeLines("```")
````

You can see that it contains `{{{ head }}}`, `{{{ header }}}`, `{{{ navbar }}}`,
`{{{ content }}}` and `{{{ footer }}}`. These are all the results of the other
rendered templates. For example, here's the `head.html` template, which defines
the content that goes in the HTML `<head>` tag (defining titles, metadata, 
stylesheets, and JavaScript):


````{r varnish-template-head, echo = FALSE, results = "asis"}
writeLines("```html")
tplt <- system.file("pkgdown", "templates", "head.html", package = "varnish")
writeLines(readLines(tplt))
writeLines("```")
````


## Example

All of these metadata are collected and stored in memory before the lesson is
built (triggered during `validate_lesson()`), which are accessible via the
objects defined by the internal `sandpaper:::set_globals()`. Here I will set
up an example lesson that I will use to demonstrate these global variables. 
Please note that I will be using internal functions in this demonstration. These
internal functions are not guaranteed to be stable outside of the context of
{sandpaper}. Using the `asNamespace("sandpaper")` function allows me to create
a method for accessing the internal functions:

```{r create-namespace-example, message = FALSE}
library("sandpaper")
snd <- asNamespace("sandpaper")
```

```{r, create-example, message = FALSE}
# create a new lesson
lsn <- create_lesson(tempfile(), name = "An Example Lesson", 
  rstudio = TRUE, open = FALSE, rmd = FALSE)
# add a new episode
create_episode_md(title = "First Example", add = TRUE, path = lsn, open = FALSE)
```

Within {sandpaper}, there are environments that contain metadata related to the
whole lesson called `.resources`, `instructor_globals`, `learner_globals`, and
`this_metadata`. Before the lesson is validated, these values are empty:

```{r globals}
snd$.resources$get()
snd$instructor_globals$get()
snd$learner_globals$get()
snd$this_metadata$get()
```

When I run `validate_lesson()` the first time, all the metadata is collected and
parsed from the `config.yaml`, and the individual episodes and cached.

```{r validate}
# first run is always longer than the second
system.time(validate_lesson(lsn))
system.time(validate_lesson(lsn))
```


```{r resources-get}
snd$.resources$get()
snd$instructor_globals$get()
snd$learner_globals$get()
snd$this_metadata$get()
snd$get_path_site_yaml(lsn)
```



## Static Variables

### Build Options

### Metadata

## Caculated Variables

### Site-wide metadata

### Page specific data
