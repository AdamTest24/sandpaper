<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Setup a git worktree for concurrent manipulation of a separate branch — git_worktree_setup • sandpaper</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Setup a git worktree for concurrent manipulation of a separate branch — git_worktree_setup" />
<meta property="og:description" content="Setup a git worktree for concurrent manipulation of a separate branch" />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">sandpaper</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9037</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/carpentries/sandpaper/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Setup a git worktree for concurrent manipulation of a separate branch</h1>
    <small class="dont-index">Source: <a href='https://github.com/carpentries/sandpaper/blob/master/R/utils-git.R'><code>R/utils-git.R</code></a></small>
    <div class="hidden name"><code>git_worktree_setup.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Setup a git worktree for concurrent manipulation of a separate branch</p>
    </div>

    <pre class="usage"><span class='fu'>git_worktree_setup</span><span class='op'>(</span>
  path <span class='op'>=</span> <span class='st'>"."</span>,
  <span class='va'>dest_dir</span>,
  branch <span class='op'>=</span> <span class='st'>"gh-pages"</span>,
  remote <span class='op'>=</span> <span class='st'>"origin"</span>,
  throwaway <span class='op'>=</span> <span class='cn'>FALSE</span>
<span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>path</th>
      <td><p>path to the repository</p></td>
    </tr>
    <tr>
      <th>dest_dir</th>
      <td><p>path to the destination directory to contain the work tree</p></td>
    </tr>
    <tr>
      <th>branch</th>
      <td><p>the branch associated with the work tree (default: gh-pages)</p></td>
    </tr>
    <tr>
      <th>remote</th>
      <td><p>the remote name (default: origin)</p></td>
    </tr>
    <tr>
      <th>throwaway</th>
      <td><p>if <code>TRUE</code>, the worktree created is in a detached HEAD state
from from the remote branch and will not create a new branch in your
repository. Defaults to <code>FALSE</code>, which will create the branch from upstream.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>an <code><a href='https://rdrr.io/r/base/expression.html'>expression()</a></code> that calls <code>git worktree remove</code> on the worktree
when evaluated.</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>This function is used in continuous integration settings where we want to
push derived outputs to non-main branches in our repository. We use this to
populate the markdown and HTML outputs from the lesson so that we don't have
to rebuild the lesson from scratch every time.</p>
<p>The logic behind this looks like</p><pre>worktree setup
[IF BRANCH DOES NOT EXIST]
  git checkout --orphan &lt;branch&gt;
  git rm -rf --quiet .
  git commit --allow-empty -m
  git push remote HEAD:&lt;branch&gt;
  git checkout -
git fetch &lt;remote&gt; +refs/heads/&lt;branch&gt;:refs/remotes/&lt;remote&gt;/&lt;branch&gt;
git worktree add --track -B &lt;branch&gt; /path/to/dir &lt;remote&gt;/&lt;branch&gt;
</pre>

    <h2 class="hasAnchor" id="note"><a class="anchor" href="#note"></a>Note</h2>

    <p>this internal function has been modified from the logic in
<code><a href='https://pkgdown.r-lib.org/reference/deploy_to_branch.html'>pkgdown::deploy_to_branch()</a></code>, by Hadley Wickham.</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='va'>run_ok</span> <span class='op'>&lt;-</span> <span class='fu'>sandpaper</span><span class='fu'>:::</span><span class='fu'>has_git</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>&amp;&amp;</span>
  <span class='fu'><a href='https://rdrr.io/r/base/ns-load.html'>requireNamespace</a></span><span class='op'>(</span><span class='st'>"withr"</span>, quietly <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span> <span class='op'>&amp;&amp;</span>
  <span class='fu'>rmarkdown</span><span class='fu'>::</span><span class='fu'><a href='https://pkgs.rstudio.com/rmarkdown/reference/pandoc_available.html'>pandoc_available</a></span><span class='op'>(</span><span class='st'>"2.11"</span><span class='op'>)</span>

<span class='co'># Use Worktrees to deploy a lesson -----------------------------------------</span>
<span class='co'># This example is a bit inovlved, but it is effectively what we do inside of</span>
<span class='co'># the `ci_deploy()` function (after setting up the lesson). </span>
<span class='co'># </span>
<span class='co'># The setup phase will create a new lesson and a corresponding remote (self</span>
<span class='co'># contained, no GitHub authentication required). </span>
<span class='co'># </span>
<span class='co'># The worktrees will be created for both the markdown and HTML outputs on the</span>
<span class='co'># branches "md-outputs" and "gh-pages", respectively. </span>
<span class='co'># </span>
<span class='co'># After the worktrees are created, we will build the lesson into the</span>
<span class='co'># worktrees and display the output of `git_status()` for each of the three</span>
<span class='co'># branches: "main", "md-outputs", and "gh-pages"</span>
<span class='co'># </span>
<span class='co'># During the clean up phase, the output of `git_worktree_setup()` is </span>
<span class='co'># evaluated</span>
<span class='kw'>if</span> <span class='op'>(</span><span class='va'>run_ok</span><span class='op'>)</span> <span class='op'>{</span>
<span class='fu'>cli</span><span class='fu'>::</span><span class='fu'><a href='https://cli.r-lib.org/reference/cli_h1.html'>cli_h1</a></span><span class='op'>(</span><span class='st'>"Set up"</span><span class='op'>)</span>
<span class='fu'>cli</span><span class='fu'>::</span><span class='fu'><a href='https://cli.r-lib.org/reference/cli_h1.html'>cli_h2</a></span><span class='op'>(</span><span class='st'>"Create Lesson"</span><span class='op'>)</span>
<span class='va'>restore_fixture</span> <span class='op'>&lt;-</span> <span class='fu'>sandpaper</span><span class='fu'>:::</span><span class='fu'><a href='create_test_lesson.html'>create_test_lesson</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/options.html'>getOption</a></span><span class='op'>(</span><span class='st'>"sandpaper.test_fixture"</span><span class='op'>)</span>
<span class='fu'>sandpaper</span><span class='fu'>:::</span><span class='fu'>check_git_user</span><span class='op'>(</span><span class='va'>res</span><span class='op'>)</span>
<span class='fu'>cli</span><span class='fu'>::</span><span class='fu'><a href='https://cli.r-lib.org/reference/cli_h1.html'>cli_h2</a></span><span class='op'>(</span><span class='st'>"Create Remote"</span><span class='op'>)</span>
<span class='va'>rmt</span> <span class='op'>&lt;-</span> <span class='fu'>fs</span><span class='fu'>::</span><span class='fu'><a href='http://fs.r-lib.org/reference/file_temp.html'>file_temp</a></span><span class='op'>(</span>pattern <span class='op'>=</span> <span class='st'>"REMOTE-"</span><span class='op'>)</span>
<span class='fu'>sandpaper</span><span class='fu'>:::</span><span class='fu'><a href='create_test_lesson.html'>setup_local_remote</a></span><span class='op'>(</span>repo <span class='op'>=</span> <span class='va'>res</span>, remote <span class='op'>=</span> <span class='va'>rmt</span>, verbose <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span>
<span class='fu'>cli</span><span class='fu'>::</span><span class='fu'><a href='https://cli.r-lib.org/reference/cli_h1.html'>cli_h2</a></span><span class='op'>(</span><span class='st'>"Create Worktrees"</span><span class='op'>)</span>
<span class='va'>db</span> <span class='op'>&lt;-</span> <span class='fu'>sandpaper</span><span class='fu'>:::</span><span class='fu'>git_worktree_setup</span><span class='op'>(</span><span class='va'>res</span>, <span class='fu'>fs</span><span class='fu'>::</span><span class='fu'><a href='http://fs.r-lib.org/reference/path.html'>path</a></span><span class='op'>(</span><span class='va'>res</span>, <span class='st'>"site"</span>, <span class='st'>"built"</span><span class='op'>)</span>, 
  branch <span class='op'>=</span> <span class='st'>"md-outputs"</span>, remote <span class='op'>=</span> <span class='st'>"sandpaper-local"</span>
<span class='op'>)</span>
<span class='va'>ds</span> <span class='op'>&lt;-</span> <span class='fu'>sandpaper</span><span class='fu'>:::</span><span class='fu'>git_worktree_setup</span><span class='op'>(</span><span class='va'>res</span>, <span class='fu'>fs</span><span class='fu'>::</span><span class='fu'><a href='http://fs.r-lib.org/reference/path.html'>path</a></span><span class='op'>(</span><span class='va'>res</span>, <span class='st'>"site"</span>, <span class='st'>"docs"</span><span class='op'>)</span>, 
  branch <span class='op'>=</span> <span class='st'>"gh-pages"</span>, remote <span class='op'>=</span> <span class='st'>"sandpaper-local"</span>
<span class='op'>)</span>
<span class='fu'>cli</span><span class='fu'>::</span><span class='fu'><a href='https://cli.r-lib.org/reference/cli_h1.html'>cli_h1</a></span><span class='op'>(</span><span class='st'>"Build Lesson into worktrees"</span><span class='op'>)</span>
<span class='fu'><a href='build_lesson.html'>build_lesson</a></span><span class='op'>(</span><span class='va'>res</span>, quiet <span class='op'>=</span> <span class='cn'>TRUE</span>, preview <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span>
<span class='fu'>cli</span><span class='fu'>::</span><span class='fu'><a href='https://cli.r-lib.org/reference/cli_h1.html'>cli_h2</a></span><span class='op'>(</span><span class='st'>"git status: {gert::git_branch(repo = res)}"</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='fu'>gert</span><span class='fu'>::</span><span class='fu'><a href='https://docs.ropensci.org/gert/reference/git_commit.html'>git_status</a></span><span class='op'>(</span>repo <span class='op'>=</span> <span class='va'>res</span><span class='op'>)</span><span class='op'>)</span>
<span class='fu'>cli</span><span class='fu'>::</span><span class='fu'><a href='https://cli.r-lib.org/reference/cli_h1.html'>cli_h2</a></span><span class='op'>(</span><span class='st'>'git status: {gert::git_branch(repo = fs::path(res, "site", "built"))}'</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='fu'>gert</span><span class='fu'>::</span><span class='fu'><a href='https://docs.ropensci.org/gert/reference/git_commit.html'>git_status</a></span><span class='op'>(</span>repo <span class='op'>=</span> <span class='fu'>fs</span><span class='fu'>::</span><span class='fu'><a href='http://fs.r-lib.org/reference/path.html'>path</a></span><span class='op'>(</span><span class='va'>res</span>, <span class='st'>"site"</span>, <span class='st'>"built"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>
<span class='fu'>cli</span><span class='fu'>::</span><span class='fu'><a href='https://cli.r-lib.org/reference/cli_h1.html'>cli_h2</a></span><span class='op'>(</span><span class='st'>'git status: {gert::git_branch(repo = fs::path(res, "site", "docs"))}'</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='fu'>gert</span><span class='fu'>::</span><span class='fu'><a href='https://docs.ropensci.org/gert/reference/git_commit.html'>git_status</a></span><span class='op'>(</span>repo <span class='op'>=</span> <span class='fu'>fs</span><span class='fu'>::</span><span class='fu'><a href='http://fs.r-lib.org/reference/path.html'>path</a></span><span class='op'>(</span><span class='va'>res</span>, <span class='st'>"site"</span>, <span class='st'>"docs"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>
<span class='fu'>cli</span><span class='fu'>::</span><span class='fu'><a href='https://cli.r-lib.org/reference/cli_h1.html'>cli_h1</a></span><span class='op'>(</span><span class='st'>"Clean Up"</span><span class='op'>)</span>
<span class='fu'>cli</span><span class='fu'>::</span><span class='fu'><a href='https://cli.r-lib.org/reference/cli_alert.html'>cli_alert_info</a></span><span class='op'>(</span><span class='st'>"object db is an expression that evaluates to {.code {db}}"</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/eval.html'>eval</a></span><span class='op'>(</span><span class='va'>db</span><span class='op'>)</span>
<span class='fu'>cli</span><span class='fu'>::</span><span class='fu'><a href='https://cli.r-lib.org/reference/cli_alert.html'>cli_alert_info</a></span><span class='op'>(</span><span class='st'>"object ds is an expression that evaluates to {.code {ds}}"</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/eval.html'>eval</a></span><span class='op'>(</span><span class='va'>ds</span><span class='op'>)</span>
<span class='fu'>sandpaper</span><span class='fu'>:::</span><span class='fu'><a href='create_test_lesson.html'>remove_local_remote</a></span><span class='op'>(</span>repo <span class='op'>=</span> <span class='va'>res</span><span class='op'>)</span>
<span class='fu'>sandpaper</span><span class='fu'>:::</span><span class='fu'>reset_git_user</span><span class='op'>(</span><span class='va'>res</span><span class='op'>)</span>
<span class='co'># remove the test fixture and report</span>
<span class='kw'><a href='https://rdrr.io/r/base/conditions.html'>tryCatch</a></span><span class='op'>(</span><span class='fu'>fs</span><span class='fu'>::</span><span class='fu'><a href='http://fs.r-lib.org/reference/delete.html'>dir_delete</a></span><span class='op'>(</span><span class='va'>res</span><span class='op'>)</span>, error <span class='op'>=</span> <span class='kw'>function</span><span class='op'>(</span><span class='op'>)</span> <span class='cn'>FALSE</span><span class='op'>)</span>
<span class='op'>}</span>
</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Zhian N. Kamvar.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


